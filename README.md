# xrmpe-server-scripts

Скрипт для управления серверами xrMPE Extension

## Описание скрипта

Скрипт предназначен для автоматического запуска, мониторинга и управления несколькими серверами игры STALKER. Он
позволяет:

- Автоматически запускать несколько серверов
- Располагать окна серверов в удобном порядке на экране
- Отслеживать состояние серверов и автоматически перезапускать их при сбоях
- Отправлять уведомления в Discord при частых перезапусках
- Создавать необходимые конфигурационные файлы

## Параметры конфигурации (servers_config.json)

### Основные параметры

| Параметр                       | Описание                                                         | Пример значения                           |
|--------------------------------|------------------------------------------------------------------|-------------------------------------------|
| `gamePath`                     | Путь к папке с игрой                                             | `"E:\\X-Ray Multiplayer Extension\\game"` |
| `serversDataPath`              | Путь к папке с данными серверов                                  | `"E:\\xrMPE_Server\\app_datas\\"`         |
| `debug`                        | Включение/выключение режима отладки                              | `true` или `false`                        |
| `debugLogFile`                 | Имя файла для записи отладочной информации                       | `"server_debug.log"`                      |
| `killServersOnStartScript`     | Завершать ли существующие процессы серверов при запуске скрипта  | `true` или `false`                        |
| `serverHangTimeout`            | Время в секундах, после которого сервер считается зависшим       | `300`                                     |
| `discordWebhookUrl`            | URL для отправки уведомлений в Discord                           | `"https://discord.com/api/webhooks/..."`  |
| `restartNotificationThreshold` | Количество перезапусков, после которого отправляется уведомление | `3`                                       |

### Параметры серверов (массив `servers`)

Каждый сервер описывается следующими параметрами:

| Параметр       | Описание                                      | Пример значения                    |
|----------------|-----------------------------------------------|------------------------------------|
| `name`         | Имя сервера                                   | `"u_01"`                           |
| `port`         | Базовый порт сервера                          | `5100`                             |
| `configPrefix` | Префикс для конфигурационных файлов           | `"01"`                             |
| `radmins`      | Массив имен и паролей администраторов сервера | `["admin1=pass1", "admin2=pass2"]` |

## Процесс работы скрипта

1. **Инициализация**:

    1. Скрипт проверяет наличие файла конфигурации `servers_config.json`
    2. Если файл не найден, создается файл с настройками по умолчанию
    3. Загружается конфигурация и проверяются указанные пути


2. **Подготовка**:

    1. Проверяется и создается папка для данных серверов
    2. Если включена опция `killServersOnStartScript`, завершаются все процессы серверов
    3. Рассчитываются позиции окон для каждого сервера


3. **Запуск серверов**:

    1. Для каждого сервера из конфигурации:

        1. Создаются необходимые файлы (`user.ltx`, `banned_list.ltx` и др.)
        2. Создается или проверяется конфигурационный файл сервера
        3. Запускается процесс сервера


4. **Позиционирование окон**:

    1. Скрипт ищет окна запущенных серверов
    2. Окна располагаются на экране согласно рассчитанным позициям


5. **Мониторинг**:

    1. Скрипт постоянно проверяет состояние серверов
    2. Если сервер завершился или завис, он автоматически перезапускается
    3. Окна перезапущенных серверов заново позиционируются
    4. При достижении порога перезапусков отправляется уведомление в Discord

## Важные нюансы и рекомендации

### Расположение папок

1. **Папка скрипта**:

    1. Рекомендуется размещать скрипт на том же диске, что и игра
    2. Структура папок должна быть следующей:

```plaintext
├── start_stalker_servers.ps1
├── servers_config.json
├── scripts/
│   ├── Config.ps1
│   ├── Utilities.ps1
│   ├── WindowsAPI.ps1
│   ├── Notifications.ps1
│   └── ServerManagement.ps1
├── templates/
│   └── user.ltx
└── app_datas/ (создается автоматически, если указана в конфигурации)
```

2. **Папка данных серверов**:

    1. **ВАЖНО**: Папка с данными серверов (`serversDataPath`) должна находиться на том же диске, что и папка с игрой (
       `gamePath`)
    2. Если вы указываете относительный путь, он будет относительно папки скрипта
    3. Для каждого сервера создается подпапка с именем `{configPrefix}_server`

### Настройка параметров

1. **Порты серверов**:

    1. Для каждого сервера указывается базовый порт
    2. Скрипт автоматически использует три последовательных порта:

        1. Базовый порт (например, 5100) - для сервера
        2. Базовый порт + 1 (5101) - для GameSpy
        3. Базовый порт + 2 (5102) - для клиентов

    3. Убедитесь, что порты не пересекаются между серверами

2. **Отладка**:

    1. Параметр `debug` включает подробное логирование
    2. Логи записываются в файл, указанный в `debugLogFile`
    3. Рекомендуется включать отладку при первоначальной настройке или при возникновении проблем


3. **Уведомления Discord**:

    1. Для работы уведомлений необходимо создать webhook в Discord и указать его URL
    2. Уведомления отправляются, когда количество перезапусков сервера достигает или превышает
       `restartNotificationThreshold`

## Запуск скрипта

1. Откройте PowerShell с правами администратора
2. Перейдите в папку со скриптом: `cd путь_к_папке_со_скриптом`
3. Если это первый запуск, выполните: `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass`
4. Запустите скрипт: `.\start_stalker_servers.ps1`

## Возможные проблемы и их решения

1. **Ошибка "Не удалось создать конфигурационный файл сервера"**:

    1. Проверьте, что файл `fsgame_s.ltx` существует в папке игры
    2. Убедитесь, что у скрипта есть права на запись в папку игры


2. **Окна серверов не перемещаются в нужные позиции**:

    1. Увеличьте значение `WINDOW_MOVE_ATTEMPTS` в начале скрипта
    2. Увеличьте значение `WINDOW_MOVE_DELAY` для более длительного ожидания между попытками


3. **Серверы часто перезапускаются**:

    1. Проверьте логи на наличие ошибок
    2. Увеличьте значение `serverHangTimeout` для более длительного ожидания перед принудительным перезапуском


4. **Ошибка "Папка игры и папка данных серверов должны находиться на одном диске"**:

    1. Переместите папку данных серверов на тот же диск, что и папка игры
    2. Или измените путь в конфигурации на папку, находящуюся на том же диске


5. **Ошибка выполнения политики PowerShell**:

    1. Выполните команду: `Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass`
    2. Или запустите PowerShell с параметром: `powershell -ExecutionPolicy Bypass -File start_stalker_servers.ps1`